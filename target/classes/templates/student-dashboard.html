<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<!--header-->
<div th:replace="fragment :: header"></div>
<!--header-->

<section class="ftco-section">
    <div class="container">
        <div class="row justify-content-center mb-5">
            <div class="col-md-8 text-center">
                <h2>Student Dashboard</h2>
                <p>View your current assignments and submission status here.</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title">Assignments</h3>

                        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
                        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                        <div th:if="${#lists.isEmpty(assignments)}" class="alert alert-info">
                            No assignments are currently available.
                        </div>

                        <div th:if="${!#lists.isEmpty(assignments)}">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Assignment</th>
                                    <th>Description</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Submit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="assignment : ${assignments}">
                                    <td th:text="${assignment.title}"></td>
                                    <td th:text="${assignment.description}"></td>
                                    <td th:text="${#temporals.format(assignment.dueDate, 'MMM d, yyyy')}"></td>
                                    <td>
                                        <span th:if="${submissions[assignment.id] != null}" class="badge badge-success">Submitted</span>
                                        <span th:if="${submissions[assignment.id] == null and assignment.dueDate.isBefore(T(java.time.LocalDate).now())}" class="badge badge-danger">Overdue</span>
                                        <span th:if="${submissions[assignment.id] == null and !assignment.dueDate.isBefore(T(java.time.LocalDate).now())}" class="badge badge-warning">Not Submitted</span>
                                    </td>
                                    <td>
                                        <div th:if="${submissions[assignment.id] != null}" class="small text-muted">
                                            <div>
                                                <span>Submitted on </span>
                                                <span th:text="${#temporals.format(submissions[assignment.id].submittedAt, 'MMM d, yyyy HH:mm')}"></span>
                                            </div>
                                            <div th:if="${submissions[assignment.id].fileName != null}">
                                                <span>File: </span>
                                                <span th:text="${submissions[assignment.id].fileName}"></span>
                                            </div>
                                            <div class="mt-2" th:if="${submissions[assignment.id].gradedAt != null and submissions[assignment.id].grade != null}">
                                                <div>
                                                    <strong>Grade:</strong>
                                                    <span th:text="${T(java.lang.String).format('%.2f', submissions[assignment.id].grade)}"></span>
                                                    <span>%</span>
                                                </div>
                                                <div th:if="${submissions[assignment.id].feedback != null}">
                                                    <strong>Feedback:</strong>
                                                    <span th:text="${submissions[assignment.id].feedback}"></span>
                                                </div>
                                                <div class="text-muted">
                                                    <small>Graded on </small>
                                                    <small th:text="${#temporals.format(submissions[assignment.id].gradedAt, 'MMM d, yyyy HH:mm')}"></small>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-muted" th:if="${submissions[assignment.id].gradedAt == null or submissions[assignment.id].grade == null}">
                                                Awaiting grading.
                                            </div>
                                            <div class="text-danger mt-2">Resubmission is not allowed.</div>
                                        </div>
                                        <div th:if="${submissions[assignment.id] == null}">
                                            <div th:if="${assignment.dueDate.isBefore(T(java.time.LocalDate).now())}" class="text-muted">Submission closed.</div>
                                            <form th:if="${!assignment.dueDate.isBefore(T(java.time.LocalDate).now())}"
                                                  th:action="@{'/student/assignments/' + ${assignment.id} + '/submit'}" method="post"
                                                  enctype="multipart/form-data" class="submission-form"
                                                  th:attr="data-assignment-title=${assignment.title}">
                                                <div class="form-group">
                                                    <textarea class="form-control mb-2" name="content" rows="2" placeholder="Enter submission notes"></textarea>
                                                </div>
                                                <div class="form-group">
                                                    <input class="form-control-file mb-2" type="file" name="file">
                                                </div>
                                                <div class="text-right">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!--Footer-->
<div th:replace="fragment :: footer"></div>
<!--Footer-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const submissionForms = document.querySelectorAll('.submission-form');
        submissionForms.forEach(function (form) {
            form.addEventListener('submit', function (event) {
                const assignmentTitle = form.getAttribute('data-assignment-title') || 'this assignment';
                const textArea = form.querySelector('textarea[name="content"]');
                const fileInput = form.querySelector('input[type="file"][name="file"]');
                const hasText = textArea && textArea.value.trim().length > 0;
                const hasFile = fileInput && fileInput.files && fileInput.files.length > 0 && fileInput.files[0].size > 0;

                if (!hasText && !hasFile) {
                    event.preventDefault();
                    alert('Please enter some text or attach a file before submitting.');
                    return;
                }
                const firstConfirmation = confirm('Are you sure you want to submit "' + assignmentTitle + '"?');
                if (!firstConfirmation) {
                    event.preventDefault();
                    return;
                }
                const secondConfirmation = confirm('This submission cannot be changed later. Do you want to proceed?');
                if (!secondConfirmation) {
                    event.preventDefault();
                }
            });
        });
    });
</script>
</body>
</html>